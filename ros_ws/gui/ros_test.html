<!DOCTYPE html>
<html>
<head>
    <!-- Include the font awesome library for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <title>ROS Test Connection</title>

    <!-- Three.js Library as ES Module -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@v0.159.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@v0.159.0/examples/jsm/"
          }
        }
    </script>
    <script type="module" src="3dplotter.js"></script>

    <script type="text/javascript" src="lib/roslib.min.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            // ################################################################## //
            //                          Connect to ROS                            //
            // ################################################################## //

            var ros = new ROSLIB.Ros({
                url : 'ws://localhost:9090'
            });

            ros.on('connection', function() {
                console.log('Connected to websocket server.');
            });

            ros.on('error', function(error) {
                console.log('Error connecting to websocket server: ', error);
            });

            ros.on('close', function() {
                console.log('Connection to websocket server closed.');
            });

            // ################################################################## //
            //                      Initialize the 3D Plotter                     //
            // ################################################################## //

            initPlotter();

            // ################################################################## //
            //                  Subscribe to /rosout (for logging)                //
            // ################################################################## //

            // Get the console div element
            var consoleDiv = document.getElementById('ros-console');

            // Set a limit for how many messages are stored in the console
            var maxMessages = 100;

            // Subscribe to the /rosout topic
            var listener = new ROSLIB.Topic({
                ros: ros,
                name: '/rosout',
                messageType: 'rcl_interfaces/msg/Log'
            });

            // Define a function to map the log level to a color
            function getLogLevelColor(level) {
                switch(level) {
                    case 10: return '#808080'; // DEBUG: Grey
                    case 20: return '#000000'; // INFO: Black
                    case 30: return '#FFA500'; // WARN: Orange
                    case 40: return '#FF4500'; // ERROR: Red-Orange
                    case 50: return '#FF0000'; // FATAL: Red
                    default: return '#000000'; // Default color for unknown levels
                }
            }

            // Add a listener function to /rosout
            listener.subscribe(function(message) {
                // Check if the message level is enabled
                if (!document.getElementById(`log-level-${message.level}`).checked) {
                    return; // Do nothing if the message level is not enabled
                }

                // Set the color of the console div based on the log level
                var logColor = getLogLevelColor(message.level);

                // Get the current time
                var currentDate = new Date();
                var timestamp = currentDate.getHours() + ':' + currentDate.getMinutes() + ':' + currentDate.getSeconds(); 

                // Create a new log entry
                var logEntry = document.createElement('div');
                logEntry.textContent = `[${timestamp}] [${message.name}]: ${message.msg}`;
                logEntry.style.color = logColor;

                // Add bold font and background color for FATAL messages
                if (message.level === 50) {
                    logEntry.style.fontWeight = 'bold';
                    logEntry.style.backgroundColor = '#ffcccc'; // Light red background
                    logEntry.style.padding = '2px';
                }
                
                // Add the log entry to the console
                consoleDiv.appendChild(logEntry);

                // Remove the oldest log entry if the console is full
                if (consoleDiv.childElementCount > maxMessages) {
                    consoleDiv.removeChild(consoleDiv.firstChild);
                }

                // Scroll to the bottom of the console
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            });
            
            // ################################################################## //
            //                      Subscribe to Robot State                      //
            // ################################################################## //

            var robotStateTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/jugglebot/robot_state_topic',
                messageType : '/jugglebot_interfaces/RobotStateMessage'
            });

            robotStateTopic.subscribe(function(message) {
                // Update the GUI
                if (message.is_homed) {
                    document.getElementById('spacemouse-control-button').disabled = false;
                }
            });

            // ################################################################## //
            //                    Interfacing with Pose Topic                     //
            // ################################################################## //

            var poseTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/jugglebot/platform_pose_topic',
                messageType : '/geometry_msgs/Pose'
            });

            // Initialize current pose to null
            var currentPose = null;

            poseTopic.subscribe(function(message) {
                // Store the current pose
                currentPose = message;
            });

            function adjustPose(deltaX, deltaY, deltaZ) {
                if (currentPose) {
                    currentPose.position.x += deltaX;
                    currentPose.position.y += deltaY;
                    currentPose.position.z += deltaZ;
                }

                // Publish the new pose
                poseTopic.publish(currentPose);
            }

            // ################################################################## //
            //                     Calling a Trigger Service                      //
            // ################################################################## //

            function callTriggerService(serviceName) {
                var service = new ROSLIB.Service({
                    ros : ros,
                    name : serviceName,
                    serviceType : 'std_srvs/srv/Trigger'
                });

                var request = new ROSLIB.ServiceRequest(); // Empty request for Trigger call

                service.callService(request, function(response) {
                    console.log('Received response: Has robot been homed? ', response);
                }, function(error) {
                    console.log('Service call failed: ', error);
                });
            }

            // ################################################################## //
            //                        Sending Control Mode                        //
            // ################################################################## //

            function sendControlMode(mode) {
                var cmdTopic = new ROSLIB.Topic({
                    ros : ros,
                    name : '/jugglebot/control_state_topic',
                    messageType : 'std_msgs/String'
                });

                var message = new ROSLIB.Message({
                    data : mode
                });

                cmdTopic.publish(message);
            }

            // ################################################################## //
            //                           Button Listeners                         //
            // ################################################################## //

            document.getElementById('home').addEventListener('click', function() {
                callTriggerService('/jugglebot/home_robot');
            });

            document.getElementById('end-session').addEventListener('click', function() {
                callTriggerService('/jugglebot/end_session');
            });

            let isSpacemouseControl = false; // Initial state is 'gui' control

            document.getElementById('spacemouse-control-button').addEventListener('click', function() {
                if (this.disabled) {
                    return; // Do nothing if button is disabled (robot not homed)
                }

                isSpacemouseControl = !isSpacemouseControl;  // Toggle state
                
                if (isSpacemouseControl) {
                    this.innerHTML = 'Switch to GUI Control';
                    this.style.backgroundColor = '#4CAF50'  // Green for Spacemouse control
                    // Send command to ROS
                    sendControlMode('spacemouse');
                } else {
                    this.innerHTML = 'Switch to Spacemouse Control';
                    this.style.backgroundColor = '#f44336'  // Red for GUI control
                    // Send command to ROS
                    sendControlMode('gui');
                }
            });           
  
            // To clear the console
            document.getElementById('clear-console-btn').addEventListener('click', function() {
                var consoleDiv = document.getElementById('ros-console');
                consoleDiv.innerHTML = '';
            });
            
            // For jogging buttons
            document.getElementById('jog-x-pos').addEventListener('click', function() {adjustPose(0.1, 0, 0);});
            document.getElementById('jog-x-neg').addEventListener('click', function() {adjustPose(-0.1, 0, 0);});
            document.getElementById('jog-y-pos').addEventListener('click', function() {adjustPose(0, 0.1, 0);});
            document.getElementById('jog-y-neg').addEventListener('click', function() {adjustPose(0, -0.1, 0);});
            document.getElementById('jog-z-pos').addEventListener('click', function() {adjustPose(0, 0, 0.1);});
            document.getElementById('jog-z-neg').addEventListener('click', function() {adjustPose(0, 0, -0.1);});
        };
    </script>

    <style>
        /* Style for the main container */
        #main-container {
            margin: 10px;
        }

        #top-row, #bottom-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        /* Style for the 3D plotter */
        #plot-3d {
            width: 800px;
            height: 600px;
            border: 2px solid #000000; /* Border color and thickness */
            background-color: #f5f5f5; /* Background color of the box */
            margin: 10px; /* Space outside the box */
        }

        /* Style for the outer button group */
        #button-container {
            display: flex; /* Make the div element a flex container */
            flex-direction: column; /* Stack items vertically */
            align-items: center; /* Center items horizontally */
            border: 2px solid #000000; /* Border color and thickness */
            width: 360px;
            padding: 5px; /* Space inside the box */
            margin: 10px; /* Space outside the box */
            background-color: #f5f5f5; /* Background color of the box */
        }

        /* Style for the ROS logging console */
        #ros-console {
            width: 1000px;
            height: 200px;
            overflow-y: scroll;
            border: 2px solid #000000; /* Border color and thickness */
            background-color: #f5f5f5; /* Background color of the box */
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #000000;
            padding: 10px;
            margin: 10px;
        }

        /* Style for the log level filters */
        #log-level-filters {
            width: fit-content;
            /* height: fit-content; */
            padding: 10px;
            margin: 10px;
            border: 2px solid #000000; /* Border color and thickness */
            background-color: #f5f5f5; /* Background color of the box */
            font-family: 'Courier New', monospace;
            font-size: 20px;
        }

        /* Style for each log level filter */
        #log-level-filters div {
            margin-bottom: 5px; /* Space between each filter */
        }

        /* Style for the log level filter checkboxes */
        .log-level {
            transform: scale(1.5); /* Make the checkboxes bigger */
            margin-right: 5px; /* Space between checkbox and label */
        }

        /* Style for the labels to match log level colors */
        #log-level-10 + label {
            color: #808080; /* Grey for DEBUG */
        }
        #log-level-20 + label {
            color: #000000; /* Black for INFO */
        }
        #log-level-30 + label {
            color: #FFA500; /* Orange for WARN */
        }
        #log-level-40 + label {
            color: #FF4500; /* Red-Orange for ERROR */
        }
        #log-level-50 + label {
            color: #FF0000; /* Red for FATAL */
            background-color: #ffcccc; /* Light red background */
            padding: 2px;
            font-weight: bold;
        }

        /* Style for the control buttons */
        #control-buttons {
            display: flex; /* Make the div element a flex container */
            flex-direction: column; /*Stack items vertically */
            width: fit-content;
            align-items: center; /* Center items vertically */
            border: 2px solid #000000; /* Border color and thickness */
            padding: 10px; /* Space inside the box */
            margin: 10px; /* Space outside the box */
            background-color: #f5f5f5; /* Background color of the box */
        }

        /* Style for the end-session button */
        #end-session {
            background-color: #f44336; /* Red color */
        }
        #end-session:hover {
            background-color: #d32f2f; /* Darker red color */
        }

        /* Style for the clear console button */
        #clear-console-btn {
            margin-top: 15px; /* Space above the box */
        }

        /* Style for the jog buttons */
        #jog-x-pos, #jog-x-neg {
            background-color: rgb(252, 66, 66);
        }

        #jog-y-pos, #jog-y-neg {
            background-color: rgb(60, 148, 60);
        }

        #jog-z-pos, #jog-z-neg {
            background-color: rgb(92, 92, 255);
        }

        /* Style for the jogging buttons container */
        #jogging-buttons {
            display: flex; /* Make the div element a flex container */
            width: fit-content;
            flex-direction: column; /* Stack rows vertically */
            align-items: center; /* Center rows horizontally */
            border: 2px solid #3f3f3f; /* Border color and thickness */
            padding: 10px; /* Space inside the box */
            margin: 10px; /* Space outside the box */
            background-color: #f5f5f5; /* Background color of the box */
        }

        /* Style for each row of buttons */
        .button-row {
            display: flex; /* Make each row a flex container */
            flex-direction: row; /* Align buttons horizontally in the row */
            justify-content: space-between; /* Space out buttons in the row */
            margin-bottom: 10px; /* Space between rows */
        }

        .button-row button {
            margin-right: 10px; /* Space between buttons within a row */
        }

        /* Style for disabled buttons */
        button:disabled{
            background-color: #cccccc; /* Grey color */
            color: #666666; /* Darker text color */
            cursor: not-allowed;
        }

        /* Hover effects for buttons */
        button:hover {
            background-color: #919191;
        }

        button {
            border-radius: 10px;
            display: flex; /* Make the button elements flex containers */
            flex-direction: column; /* Stack items vertically */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically */
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            border: none;
            color: #f7f7f7;
            background-color: #666666; /* Grey color */
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button-icon {
            /* Style for the icon */
            font-size: 24px; /* Icon size */
            margin-bottom: 5px; /* Space between icon and text */
        }

        .button-text {
            /* Style for the text */
            font-size: 16px; /* Text size */
        }
    </style>
</head>
<body>
    <div id="main-container">

        <div id="top-row">
            <!-- 3D Plotter -->
            <div id="plot-3d"></div>

            <!-- Button Container -->
            <div id="button-container">
                <!-- Control buttons -->
                <div id="control-buttons">
                    <!-- Container for the first two buttons -->
                    <div class="button-row">
                        <button id="home">
                            <span class="button-icon"><i class="fa-solid fa-house-chimney"></i></span>
                            <span class="button-text">Home</span>
                        </button>
                        <button id="end-session">
                            <span class="button-icon"><i class="fa-solid fa-power-off"></i></span>
                            <span class="button-text">End Session</span>
                        </button>
                    </div>
                
                    <!-- Container for the spacemouse control button -->
                    <div class="button-row">
                        <button id="spacemouse-control-button" disabled>Switch to SpaceMouse Control</button>
                    </div>
                </div>
                

                <!-- Jogging buttons -->
                <div id="jogging-buttons">
                    <!-- Add a title to the jog button group -->
                    <h3>Jogging</h3>
                    <div class="button-row">
                        <button id="jog-x-pos">Jog X+</button>
                        <button id="jog-x-neg">Jog X-</button>
                    </div>
                    <div class="button-row">
                        <button id="jog-y-pos">Jog Y+</button>
                        <button id="jog-y-neg">Jog Y-</button>
                    </div>
                    <div class="button-row">
                        <button id="jog-z-pos">Jog Z+</button>
                        <button id="jog-z-neg">Jog Z-</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="bottom-row">
            <!-- ROS Logging Console -->
            <div id="ros-console" ></div>
        
            <!-- Log Level Filters -->
            <div id="log-level-filters">
                <div><input type="checkbox" id="log-level-10" class="log-level" unchecked> <label for="log-level-10">Debug</label></div>
                <div><input type="checkbox" id="log-level-20" class="log-level" checked> <label for="log-level-20">Info</label></div>
                <div><input type="checkbox" id="log-level-30" class="log-level" checked> <label for="log-level-30">Warn</label></div>
                <div><input type="checkbox" id="log-level-40" class="log-level" checked> <label for="log-level-40">Error</label></div>
                <div><input type="checkbox" id="log-level-50" class="log-level" checked> <label for="log-level-50">Fatal</label></div>
                <button id="clear-console-btn">Clear Console</button>
            </div>
        </div>

    </div>

</body>
</html>
